<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Embedmongo.flapdoodle.de : " />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Embedmongo.flapdoodle.de</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de">View on GitHub</a>

          <h1 id="project_title">Embedmongo.flapdoodle.de</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/flapdoodle-oss/embedmongo.flapdoodle.de/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>Organisation Flapdoodle OSS</h1>

<p>We are now a github organisation. You are invited to participate. :)</p>

<h1>Embedded MongoDB</h1>

<p>Embedded MongoDB will provide a platform neutral way for running mongodb in unittests.</p>

<h2>Why?</h2>

<ul>
<li>dropping databases causing some pains (often you have to wait long time after each test)</li>
<li>its easy, much easier as installing right version by hand</li>
<li>you can change version per test</li>
</ul><h2>Dependencies</h2>

<h3>Build on top of</h3>

<ul>
<li>Embed Process Util <a href="https://github.com/flapdoodle-oss/de.flapdoodle.embed.process">de.flapdoodle.embed.process</a>
</li>
</ul><h3>Other ways to use Embedded MongoDB</h3>

<ul>
<li>In a Maven build using <a href="https://github.com/joelittlejohn/embedmongo-maven-plugin">embedmongo-maven-plugin</a>
</li>
<li>In a Clojure/Leiningen project using <a href="https://github.com/joelittlejohn/lein-embongo">lein-embongo</a>
</li>
<li>In a Scala/specs2 specification using <a href="https://github.com/athieriot/specs2-embedmongo">specs2-embedmongo</a>
</li>
</ul><h3>Comments about Embedded MongoDB in the Wild</h3>

<p><a href="http://stackoverflow.com/questions/6437226/embedded-mongodb-when-running-integration-tests">http://stackoverflow.com/questions/6437226/embedded-mongodb-when-running-integration-tests</a>
<a href="http://www.cubeia.com/index.php/blog/archives/436">http://www.cubeia.com/index.php/blog/archives/436</a></p>

<h3>Other MongoDB Stuff</h3>

<ul>
<li>
<a href="https://github.com/thiloplanz/jmockmongo">https://github.com/thiloplanz/jmockmongo</a> - mongodb mocking</li>
<li>
<a href="https://github.com/lordofthejars/nosql-unit">https://github.com/lordofthejars/nosql-unit</a> - extended nosql unit testing</li>
</ul><h2>Howto</h2>

<h3>Maven</h3>

<p><strong>IMPORTANT NOTE: maven groupId and artifactId change</strong></p>

<ul>
<li>  groupId from <strong>de.flapdoodle.embedmongo</strong> to <strong>de.flapdoodle.embed</strong>
</li>
<li>  artifactId from <strong>de.flapdoodle.embedmongo</strong> to <strong>de.flapdoodle.embed.mongo</strong>
</li>
</ul><p>Stable (Maven Central Repository, Released: 16.12.2012 - wait 24hrs for <a href="http://repo1.maven.org/maven2/de/flapdoodle/embed/de.flapdoodle.embed.mongo/maven-metadata.xml">maven central</a>)</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;de.flapdoodle.embed&lt;/groupId&gt;
    &lt;artifactId&gt;de.flapdoodle.embed.mongo&lt;/artifactId&gt;
    &lt;version&gt;1.28&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>Snapshots (Repository <a href="http://oss.sonatype.org/content/repositories/snapshots">http://oss.sonatype.org/content/repositories/snapshots</a>)</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;de.flapdoodle.embed&lt;/groupId&gt;
    &lt;artifactId&gt;de.flapdoodle.embed.mongo&lt;/artifactId&gt;
    &lt;version&gt;1.29-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h3>Build from source</h3>

<p>When you fork or clone our branch you should always be able to build the library by running </p>

<pre><code>mvn package
</code></pre>

<p>There is also a build.gradle file available which might sometimes be outdated but we try to keep it working. So the gradle command is</p>

<pre><code>gradle build
</code></pre>

<p>Or if you want to use the gradle wrapper:</p>

<pre><code>./gradlew build
</code></pre>

<h3>Changelog</h3>

<h4>1.29 (SNAPSHOT)</h4>

<h4>1.28</h4>

<ul>
<li>mongod config refactor</li>
<li>configurable startup timeout</li>
<li>added windows2008 support</li>
</ul><h4>1.27</h4>

<ul>
<li>dep version change</li>
</ul><h4>1.26</h4>

<ul>
<li>bind_ip configuration parameter support (MongodConfig constructor)</li>
</ul><h4>1.25</h4>

<ul>
<li>dep version change</li>
</ul><h4>1.24</h4>

<ul>
<li>dep version change</li>
</ul><h4>1.23</h4>

<ul>
<li>added 2.0.7, 2.2.0</li>
<li>mongodb java driver update to 2.9.0 (test dependency)</li>
</ul><h4>1.22</h4>

<ul>
<li>maven dep version range does not work as expected -&gt; disabled</li>
</ul><h4>1.21</h4>

<ul>
<li>dependency version range for de.flapdoodle.embed.process</li>
</ul><h4>1.20</h4>

<ul>
<li>NPE fix with custom database directory</li>
<li>custom database directory will not be deleted</li>
</ul><h4>1.19</h4>

<ul>
<li><strong>massive refactoring, some api breaks</strong></li>
<li><strong>project split</strong></li>
<li>some relevant process.stop() improvements</li>
</ul><h4>1.18</h4>

<ul>
<li>added some unit test support (thanx to trajano)</li>
<li>added some logging only runtime config option</li>
<li>added 2.0.7-rc1, 2.2.0-rc0</li>
<li>command line post processor hock</li>
</ul><h4>1.17</h4>

<ul>
<li>added version 2.0.6 and 2.1.2</li>
<li>version refactoring</li>
<li>you can now have a custom version, so you do not depend on a new release of this project</li>
</ul><h4>1.16</h4>

<ul>
<li>added version 2.0.5 (main version 2.0 now points to it)</li>
<li>changed http user agent</li>
<li>customizeable mongod process output </li>
<li>better loopback device detection for mongod process shutdown via command</li>
</ul><h4>1.15</h4>

<ul>
<li>now we send ctrl+c on linux and osx, then send shutdown to server, then taskkill on windows (may the force be with us)</li>
<li>disable journal for faster turnaround times</li>
<li>noauth added</li>
<li>customize artifact storage path</li>
<li>detection if localhost is not loopback (command shutdown on mongod does not work for remote access)</li>
<li>formated process output</li>
<li>much better windows support</li>
</ul><h4>1.14</h4>

<ul>
<li>changed back to send ctrl+c and then send shutdown</li>
</ul><h4>1.13</h4>

<ul>
<li>mongod process management improvement 
(windows mongod shutdown improvement (alpha) (some trouble stopping process on windows - <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4770092)">http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4770092)</a>)

<ul>
<li>send shutdown to server</li>
<li>send ctrl+c to mongod will perform clean shutdown (untested on windows using taskkill)</li>
</ul>
</li>
<li>now with 2.1.1</li>
</ul><h4>1.12</h4>

<ul>
<li>NUMA support (alpha) - <a href="http://www.mongodb.org/display/DOCS/NUMA">http://www.mongodb.org/display/DOCS/NUMA</a>
</li>
</ul><h4>1.11</h4>

<ul>
<li>timeout fix on slow systems</li>
<li>stability on win plattforms (hopefully)</li>
</ul><h4>1.10</h4>

<ul>
<li>race condition and cleanup of mongod process</li>
</ul><h4>1.9</h4>

<ul>
<li>fixed 64Bit detection - amd64</li>
<li>now with main versions 1.6, 1.8, 2.0, 2.1</li>
</ul><h3>Supported Versions</h3>

<p>Versions: some older, 1.8.5, 1.9.0, 2.0.6, 2.1.2
Support for Linux, Windows and MacOSX.</p>

<h3>Usage</h3>

<pre><code>int port = 12345;
MongodConfig mongodConfig = new MongodConfig(Version.Main.V2_0, port, Network.localhostIsIPv6());

MongodStarter runtime = MongodStarter.getDefaultInstance();

MongodExecutable mongodExecutable = null; 
try {
    mongodExecutable = runtime.prepare(mongodConfig);
    MongodProcess mongod = mongodExecutable.start();

    Mongo mongo = new Mongo("localhost", port);
    DB db = mongo.getDB("test");
    DBCollection col = db.createCollection("testCol", new BasicDBObject());
    col.save(new BasicDBObject("testDoc", new Date()));

} finally {
    if (mongodExecutable != null)
        mongodExecutable.stop();
}
</code></pre>

<h3>Usage - custom mongod filename</h3>

<pre><code>int port = 12345;
MongodConfig mongodConfig = new MongodConfig(Version.Main.V2_0, port, Network.localhostIsIPv6());

RuntimeConfig runtimeConfig = new RuntimeConfig();
runtimeConfig.setExecutableNaming(new UserTempNaming());
MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);

MongodExecutable mongodExecutable=null;
try {
    mongodExecutable = runtime.prepare(mongodConfig);
    MongodProcess mongod = mongodExecutable.start();

    Mongo mongo = new Mongo("localhost", port);
    DB db = mongo.getDB("test");
    DBCollection col = db.createCollection("testCol", new BasicDBObject());
    col.save(new BasicDBObject("testDoc", new Date()));

} finally {
    if (mongodExecutable != null)
        mongodExecutable.stop();
}
</code></pre>

<h3>Unit Tests</h3>

<pre><code>public abstract class AbstractMongoDBTest extends TestCase {

    private MongodExecutable _mongodExe;
    private MongodProcess _mongod;

    private Mongo _mongo;
    @Override
    protected void setUp() throws Exception {

        MongodStarter runtime = MongodStarter.getDefaultInstance();
        _mongodExe = runtime.prepare(new MongodConfig(Version.Main.V2_0, 12345, Network.localhostIsIPv6()));
        _mongod = _mongodExe.start();

        super.setUp();

        _mongo = new Mongo("localhost", 12345);
    }

    @Override
    protected void tearDown() throws Exception {
        super.tearDown();

        _mongod.stop();
        _mongodExe.stop();
    }

    public Mongo getMongo() {
        return _mongo;
    }

}
</code></pre>

<h4>... with some more help</h4>

<pre><code>...
MongodForTestsFactory factory = null;
try {
    factory = MongodForTestsFactory.with(Version.Main.V2_0);

    Mongo mongo = factory.newMongo();
    DB db = mongo.getDB("test-" + UUID.randomUUID());
    DBCollection col = db.createCollection("testCol", new BasicDBObject());
    col.save(new BasicDBObject("testDoc", new Date()));

} finally {
    if (factory != null)
        factory.shutdown();
}
...
</code></pre>

<h3>Customize Artifact Storage</h3>

<pre><code>...
IArtifactStoragePathNaming artifactStorePath = ...
ITempNaming executableNaming = ...

RuntimeConfig runtimeConfig = new RuntimeConfig();
runtimeConfig.getDownloadConfig().setArtifactStorePathNaming(artifactStorePath);
runtimeConfig.setExecutableNaming(executableNaming);

MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);
MongodExecutable mongodExe = runtime.prepare(mongodConfig);
...
</code></pre>

<h3>Usage - custom mongod process output</h3>

<h4>... to console with line prefix</h4>

<pre><code>...
RuntimeConfig runtimeConfig = new RuntimeConfig();
runtimeConfig.setProcessOutput(new ProcessOutput(Processors.namedConsole("[mongod&gt;]"),
    Processors.namedConsole("[MONGOD&gt;]"), Processors.namedConsole("[console&gt;]")));
MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);
...
</code></pre>

<h4>... to file</h4>

<pre><code>...
RuntimeConfig runtimeConfig=new RuntimeConfig();
IStreamProcessor mongodOutput = Processors.named("[mongod&gt;]", new FileStreamProcessor(File.createTempFile("mongod", "log")));
IStreamProcessor mongodError = new FileStreamProcessor(File.createTempFile("mongod-error", "log"));
IStreamProcessor commandsOutput = Processors.namedConsole("[console&gt;]");

runtimeConfig.setProcessOutput(new ProcessOutput(mongodOutput,
    mongodError, commandsOutput));
MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);
...

...
public class FileStreamProcessor implements IStreamProcessor {

    private FileOutputStream outputStream;

    public FileStreamProcessor(File file) throws FileNotFoundException {
        outputStream = new FileOutputStream(file);
    }

    @Override
    public void process(String block) {
        try {
            outputStream.write(block.getBytes());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void onProcessed() {
        try {
            outputStream.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }   
}
...
</code></pre>

<h4>... to java logging</h4>

<pre><code>...
Logger logger=...

RuntimeConfig runtimeConfig = new RuntimeConfig();
runtimeConfig.setProcessOutput(new ProcessOutput(Processors.logTo(logger, Level.INFO),
        Processors.logTo(logger, Level.SEVERE), Processors.named("[console&gt;]",Processors.logTo(logger, Level.FINE))));
MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);
...
</code></pre>

<h4>... to default java logging (the easy way)</h4>

<pre><code>...

Logger logger=...

RuntimeConfig runtimeConfig = RuntimeConfig.getInstance(logger);
MongodStarter runtime = MongodStarter.getInstance(runtimeConfig);
...
</code></pre>

<h3>Custom Version</h3>

<pre><code>...
int port = 12345;
MongodProcess mongod = null;
MongodConfig mongodConfig = new MongodConfig(new GenericVersion("2.0.7-rc1"), port, Network.localhostIsIPv6());

MongodStarter runtime = MongodStarter.getDefaultInstance();

try {
    MongodExecutable mongodExecutable = runtime.prepare(mongodConfig);
    mongod = mongodExecutable.start();

    ...

} finally {
    if (mongod != null)
        mongod.stop();
}
...
</code></pre>

<h3>Main Versions</h3>

<pre><code>...
IVersion version=Version.V2_0_1;
// uses latest supported 2.1.x Version
version=Version.Main.V2_1;
// uses latest supported production version
version=Version.Main.PRODUCTION;
// uses latest supported development version
version=Version.Main.DEVELOPMENT;
</code></pre>

<h3>Use Free Server Port</h3>

<pre><code>Warning: maybe not as stable, as expected.
</code></pre>

<h4>... by hand</h4>

<pre><code>...
int port = Network.getFreeServerPort();
...
</code></pre>

<h4>... automagic</h4>

<pre><code>...
MongodProcess mongod = null;
MongodConfig mongodConfig = new MongodConfig(Version.Main.V2_0);

MongodStarter runtime = MongodStarter.getDefaultInstance();

try {
    MongodExecutable mongodExecutable = runtime.prepare(mongodConfig);
    mongod = mongodExecutable.start();

    Mongo mongo = new Mongo(new ServerAddress(mongodConfig.net().getServerAddress(), mongodConfig.net().getPort()));
}
...
</code></pre>

<h3>Command Line Post Processing</h3>

<pre><code>...
ICommandLinePostProcessor postProcessort=...

RuntimeConfig runtimeConfig = new RuntimeConfig();
runtimeConfig.setsetCommandLinePostProcessor(postProcessor);
...
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Embedmongo.flapdoodle.de maintained by <a href="https://github.com/flapdoodle-oss">flapdoodle-oss</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
